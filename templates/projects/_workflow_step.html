<div id="workflow-step-{{ control.id }}" class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
  <!-- Header -->
  <div class="px-5 py-3 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
    <h4 class="text-xs font-semibold text-slate-600 uppercase tracking-wider flex items-center gap-1.5">
      <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
      Assessment Workflow
    </h4>
    {% if breadcrumbs %}
    <button hx-post="/projects/{{ project.id }}/controls/{{ control.id }}/workflow/reset"
      hx-target="#workflow-step-{{ control.id }}" hx-swap="outerHTML"
      class="text-xs text-slate-500 hover:text-rose-600 font-medium transition-colors flex items-center gap-1">
      <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
      Restart
    </button>
    {% endif %}
  </div>

  <div class="p-5 space-y-4">
    <!-- Breadcrumb Trail -->
    {% if breadcrumbs %}
    <div class="space-y-2">
      {% for crumb in breadcrumbs %}
      <div class="flex items-start gap-3 text-sm">
        <div
          class="flex-shrink-0 w-5 h-5 rounded-full bg-emerald-100 border border-emerald-300 flex items-center justify-center mt-0.5">
          <svg class="w-3 h-3 text-emerald-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </div>
        <div>
          <span class="text-slate-600">{{ crumb.prompt }}</span>
          <span class="ml-2 font-semibold text-slate-900">{{ crumb.answer_display }}</span>
        </div>
      </div>
      {% endfor %}
    </div>
    <hr class="border-slate-200">
    {% endif %}

    {% if current_node %}
    {% if finding %}
    <!-- Terminal Node: Finding -->
    <div class="rounded-lg border-2 p-5
        {% if finding.finding_type == 'pass' %}
          border-emerald-300 bg-emerald-50
        {% elif finding.finding_type == 'fail' %}
          border-rose-300 bg-rose-50
        {% elif finding.finding_type == 'observation' %}
          border-amber-300 bg-amber-50
        {% else %}
          border-slate-300 bg-slate-50
        {% endif %}
      ">
      <div class="flex items-center gap-2 mb-3">
        {% if finding.finding_type == 'pass' %}
        <span
          class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-emerald-200 text-emerald-800 border border-emerald-300">
          PASS
        </span>
        {% elif finding.finding_type == 'fail' %}
        <span
          class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-rose-200 text-rose-800 border border-rose-300">
          FAIL
        </span>
        {% elif finding.finding_type == 'observation' %}
        <span
          class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-amber-200 text-amber-800 border border-amber-300">
          OBSERVATION
        </span>
        {% else %}
        <span
          class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold bg-slate-200 text-slate-800 border border-slate-300">
          {{ finding.finding_type|upper }}
        </span>
        {% endif %}
        <h5 class="font-semibold text-slate-900">{{ finding.title }}</h5>
      </div>
      <p class="text-sm leading-relaxed
          {% if finding.finding_type == 'pass' %}text-emerald-900
          {% elif finding.finding_type == 'fail' %}text-rose-900
          {% elif finding.finding_type == 'observation' %}text-amber-900
          {% else %}text-slate-700{% endif %}
        ">{{ finding.recommendation }}</p>
    </div>

    {% else %}
    <!-- Question Node -->
    <div class="space-y-3">
      <div class="flex items-start gap-3">
        <div
          class="flex-shrink-0 w-5 h-5 rounded-full bg-blue-100 border border-blue-300 flex items-center justify-center mt-0.5">
          <span class="text-blue-700 text-xs font-bold">?</span>
        </div>
        <p class="text-sm font-medium text-slate-900">{{ current_node.prompt }}</p>
      </div>

      {% set input_type = current_node.get('input_type', 'text') %}

      {% if input_type == 'select' %}
      <!-- Select Options as Buttons -->
      <div class="flex flex-wrap gap-2 pl-8">
        {% for option in current_node.get('options', []) %}
        <form hx-post="/projects/{{ project.id }}/controls/{{ control.id }}/workflow/answer"
          hx-target="#workflow-step-{{ control.id }}" hx-swap="outerHTML">
          <input type="hidden" name="node_id" value="{{ current_node_id }}">
          <input type="hidden" name="answer" value="{{ option.value }}">
          <button type="submit" class="px-4 py-2 text-sm font-medium rounded-lg border transition-all
                bg-white border-slate-200 text-slate-700
                hover:bg-blue-50 hover:border-blue-300 hover:text-blue-700
                focus:outline-none focus:ring-2 focus:ring-blue-500/30 shadow-sm">
            {{ option.label }}
          </button>
        </form>
        {% endfor %}
      </div>

      {% elif input_type == 'group' %}
      <!-- Group Form -->
      <form hx-post="/projects/{{ project.id }}/controls/{{ control.id }}/workflow/answer"
        hx-target="#workflow-step-{{ control.id }}" hx-swap="outerHTML" class="pl-8 space-y-4">
        <input type="hidden" name="node_id" value="{{ current_node_id }}">
        {% for field in current_node.get('fields', []) %}
        <div>
          <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1.5">
            {{ field.label }}
          </label>
          {% if field.input_type == 'select' %}
          <div class="relative w-full">
            <select name="{{ field.name }}"
              class="w-full appearance-none px-3 py-2 bg-slate-50 border border-slate-200 text-slate-900 rounded-lg hover:border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 transition-colors text-sm">
              <option value="">-- Select --</option>
              {% for opt in field.get('options', []) %}
              <option value="{{ opt.value }}">{{ opt.label }}</option>
              {% endfor %}
            </select>
            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
              <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
              </svg>
            </div>
          </div>
          {% elif field.input_type == 'textarea' %}
          <textarea name="{{ field.name }}" rows="3"
            class="w-full px-3 py-2 bg-slate-50 border border-slate-200 text-slate-900 placeholder-slate-400 rounded-lg hover:border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 transition-colors text-sm"
            placeholder="{{ field.label }}..."></textarea>
          {% elif field.input_type == 'date' %}
          <input type="date" name="{{ field.name }}"
            class="w-full px-3 py-2 bg-slate-50 border border-slate-200 text-slate-900 rounded-lg hover:border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 transition-colors text-sm">
          {% elif field.input_type == 'number' %}
          <input type="number" name="{{ field.name }}"
            class="w-full px-3 py-2 bg-slate-50 border border-slate-200 text-slate-900 rounded-lg hover:border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 transition-colors text-sm"
            placeholder="{{ field.label }}">
          {% else %}
          <input type="text" name="{{ field.name }}"
            class="w-full px-3 py-2 bg-slate-50 border border-slate-200 text-slate-900 placeholder-slate-400 rounded-lg hover:border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 transition-colors text-sm"
            placeholder="{{ field.label }}...">
          {% endif %}
        </div>
        {% endfor %}
        <button type="submit"
          class="px-4 py-2 text-sm font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-all focus:outline-none focus:ring-2 focus:ring-blue-500/50 shadow-sm">
          Continue
        </button>
      </form>

      {% else %}
      <!-- Text/Textarea/Date/Number input -->
      <form hx-post="/projects/{{ project.id }}/controls/{{ control.id }}/workflow/answer"
        hx-target="#workflow-step-{{ control.id }}" hx-swap="outerHTML" class="pl-8 space-y-3">
        <input type="hidden" name="node_id" value="{{ current_node_id }}">
        {% if input_type == 'textarea' %}
        <textarea name="answer" rows="3"
          class="w-full px-3 py-2 bg-slate-50 border border-slate-200 text-slate-900 placeholder-slate-400 rounded-lg hover:border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 transition-colors text-sm"
          placeholder="Enter your response..."></textarea>
        {% elif input_type == 'date' %}
        <input type="date" name="answer"
          class="w-full px-3 py-2 bg-slate-50 border border-slate-200 text-slate-900 rounded-lg hover:border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 transition-colors text-sm">
        {% elif input_type == 'number' %}
        <input type="number" name="answer"
          class="w-full px-3 py-2 bg-slate-50 border border-slate-200 text-slate-900 rounded-lg hover:border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 transition-colors text-sm"
          placeholder="Enter a number...">
        {% else %}
        <input type="text" name="answer"
          class="w-full px-3 py-2 bg-slate-50 border border-slate-200 text-slate-900 placeholder-slate-400 rounded-lg hover:border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:border-blue-500 transition-colors text-sm"
          placeholder="Enter your response...">
        {% endif %}
        <button type="submit"
          class="px-4 py-2 text-sm font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-all focus:outline-none focus:ring-2 focus:ring-blue-500/50 shadow-sm">
          Continue
        </button>
      </form>
      {% endif %}
    </div>
    {% endif %}

    {% else %}
    <p class="text-sm text-slate-500 italic">No workflow step available.</p>
    {% endif %}
  </div>
</div>