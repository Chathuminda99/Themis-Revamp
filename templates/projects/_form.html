<form hx-post="{% if project %}/projects/{{ project.id }}{% else %}/projects{% endif %}" {% if project %}hx-target="#project-row-{{ project.id }}" hx-swap="outerHTML" {% else %}hx-target="#projects-table" hx-swap="beforeend" {% endif %}
  @submit="if (htmx.config.refreshOnHistoryMiss) htmx.ajax('GET', '/projects', {target: '#projects-table', swap: 'innerHTML'}); $store.modal.hide()">

  <div class="space-y-6">
    <!-- Header -->
    <div>
      <h2 class="text-xl font-semibold text-foreground">{% if project %}Update Project{% else %}New Project{% endif %}</h2>
      <p class="text-sm text-muted-foreground mt-1">Fill in the details below to {% if project %}update the{% else %}create a{% endif %} project.</p>
    </div>

    <!-- Project Name -->
    <div class="space-y-2">
      <label for="name" class="text-sm font-medium text-foreground">Project Name <span class="text-destructive">*</span></label>
      <input type="text" id="name" name="name" value="{{ project.name if project else '' }}" required placeholder="Enter project name"
        class="w-full flex h-10 rounded-md border border-input bg-background px-3 py-2 text-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 transition-colors" />
    </div>

    <!-- Client Search -->
    <div class="space-y-2">
      <label for="client_id" class="text-sm font-medium text-foreground">Client <span class="text-destructive">*</span></label>
      <input type="hidden" id="client_id" name="client_id" value="{{ project.client_id if project else '' }}" required />
      <div class="relative">
        <input type="text" id="client_search" name="q" placeholder="Start typing client name..."
          value="{% if project and project.client %}{{ project.client.name }}{% endif %}" autocomplete="off"
          class="w-full flex h-10 rounded-md border border-input bg-background px-3 py-2 text-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 transition-colors"
          hx-get="/clients/search" hx-trigger="keyup changed delay:300ms" hx-target="#client-suggestions" hx-swap="innerHTML" />
        <div id="client-suggestions" class="mt-2 text-sm text-muted-foreground absolute z-50 w-full"></div>
      </div>
    </div>

    <!-- Framework Select -->
    <div class="space-y-2">
      <label for="framework-select" class="text-sm font-medium text-foreground">Framework <span class="text-destructive">*</span></label>
      <div x-data='{
          open: false,
          value: "{{ project.framework_id | string if project else "" }}",
          names: {
            {% for framework in frameworks %}"{{ framework.id }}": {{ framework.name | tojson | safe }},{% endfor %}
          },
          getLabel() { return this.names[this.value] || "Select a framework..."; }
      }' @click.outside="open = false" class="relative">
        <input type="hidden" name="framework_id" :value="value" required />
        <button type="button" id="framework-select" @click="open = !open" class="dropdown-select">
          <span x-text="getLabel()"
            :class="value ? 'text-slate-700 dark:text-slate-300' : 'text-muted-foreground'"
            class="truncate block text-left flex-1"></span>
          <span class="pointer-events-none text-muted-foreground ml-2 transition-transform duration-200" :class="open ? 'rotate-180' : ''">
            <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </span>
        </button>
        <div x-show="open" x-cloak
          x-transition:enter="transition ease-out duration-150"
          x-transition:enter-start="transform opacity-0 scale-95 translate-y-[-10px]"
          x-transition:enter-end="transform opacity-100 scale-100 translate-y-0"
          x-transition:leave="transition ease-in duration-100"
          x-transition:leave-start="transform opacity-100 scale-100 translate-y-0"
          x-transition:leave-end="transform opacity-0 scale-95 translate-y-[-10px]"
          class="dropdown-menu">
          <ul>
            {% set colors = [
              {'text': 'text-blue-600 dark:text-blue-400', 'bg': 'bg-blue-50 dark:bg-blue-900/30'},
              {'text': 'text-emerald-600 dark:text-emerald-400', 'bg': 'bg-emerald-50 dark:bg-emerald-900/30'},
              {'text': 'text-purple-600 dark:text-purple-400', 'bg': 'bg-purple-50 dark:bg-purple-900/30'},
              {'text': 'text-amber-600 dark:text-amber-400', 'bg': 'bg-amber-50 dark:bg-amber-900/30'},
              {'text': 'text-rose-600 dark:text-rose-400', 'bg': 'bg-rose-50 dark:bg-rose-900/30'}
            ] %}
            {% for framework in frameworks %}
            {% set color = colors[loop.index0 % colors|length] %}
            <li>
              <button type="button" @click='value = "{{ framework.id }}"; open = false'
                :class='value === "{{ framework.id }}" ? "bg-primary text-white shadow-md shadow-primary/25" : "text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800/60"'
                class="dropdown-item">
                <span :class='value === "{{ framework.id }}" ? "text-white" : "{{ color.text }} {{ color.bg }}"'
                  class="flex items-center justify-center w-6 h-6 rounded-full font-bold text-xs transition-colors flex-shrink-0">
                  {{ framework.name[0]|upper }}
                </span>
                <span class="truncate">{{ framework.name }}</span>
              </button>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <!-- Status Select -->
    {% set select_id = "status" %}
    {% set select_name = "status" %}
    {% set select_value = project.status.value if project else 'draft' %}
    {% set select_label = "Status" %}
    {% set select_options = [
      {"value": "draft", "label": "Draft", "icon": "edit_document", "color": "text-slate-600 dark:text-slate-400", "icon_bg": "bg-slate-100 dark:bg-slate-800"},
      {"value": "in_progress", "label": "In Progress", "icon": "pending", "color": "text-amber-600 dark:text-amber-400", "icon_bg": "bg-amber-50 dark:bg-amber-900/30"},
      {"value": "completed", "label": "Completed", "icon": "check_circle", "color": "text-emerald-600 dark:text-emerald-400", "icon_bg": "bg-emerald-50 dark:bg-emerald-900/30"},
      {"value": "archived", "label": "Archived", "icon": "inventory_2", "color": "text-slate-600 dark:text-slate-400", "icon_bg": "bg-slate-100 dark:bg-slate-800"}
    ] %}
    {% include "components/custom_select.html" with context %}

    <!-- Description -->
    <div class="space-y-2">
      <label for="description" class="text-sm font-medium text-foreground">Description</label>
      <textarea id="description" name="description" rows="4" placeholder="Enter project description (optional)"
        class="w-full flex rounded-md border border-input bg-background px-3 py-2 text-sm placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 transition-colors resize-none">{{ project.description if project else '' }}</textarea>
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-3 justify-end pt-4 border-t border-border">
      <button type="button" @click="$store.modal.hide()"
        class="inline-flex items-center justify-center gap-2 font-medium rounded-md px-4 py-2 text-sm transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed focus-visible:outline-none border border-input bg-background text-foreground hover:bg-muted">
        Cancel
      </button>
      <button type="submit"
        class="inline-flex items-center justify-center gap-2 font-medium rounded-md px-4 py-2 text-sm transition-all duration-200 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background bg-primary text-primary-foreground hover:opacity-90">
        <span class="material-symbols-outlined text-[14px]">{% if project %}edit{% else %}add_circle{% endif %}</span>
        {% if project %}Update{% else %}Create{% endif %} Project
      </button>
    </div>
  </div>
</form>