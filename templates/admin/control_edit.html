{% extends "base.html" %}

{% block title %}Edit Control Template - Admin{% endblock %}

{% block content %}
<div class="px-4 py-6 md:px-8 md:py-8 animate-fade-in-up">
    <!-- Breadcrumb & Header -->
    <div class="mb-8">
        <div class="flex items-center gap-2 text-xs text-slate-500 font-medium mb-3">
            <a href="/admin/controls" class="hover:text-primary transition-colors">Controls</a>
            <span class="material-symbols-outlined text-sm">chevron_right</span>
            <span class="text-primary">Edit</span>
        </div>

        <div class="flex items-start justify-between gap-4">
            <div>
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xs px-2 py-1 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 font-semibold">
                        {{ control.control_id }}
                    </span>
                </div>
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white tracking-tight">
                    {{ control.name }}
                </h1>
                <p class="text-slate-500 dark:text-slate-400 mt-2 text-sm">
                    {{ framework.name }} â†’ {{ section.name }}
                </p>
            </div>

            <!-- Back Button -->
            <a href="/admin/controls" class="px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors text-sm font-bold">
                Back
            </a>
        </div>
    </div>

    <!-- Success Message -->
    {% if saved %}
    <div class="mb-6 p-4 rounded-lg border border-emerald-200 dark:border-emerald-900/30 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-700 dark:text-emerald-400 flex items-start gap-3">
        <span class="material-symbols-outlined flex-shrink-0 text-[20px]">check_circle</span>
        <div>
            <p class="font-bold text-sm">Template saved successfully!</p>
            <p class="text-xs mt-1">Your changes have been saved to the database.</p>
        </div>
    </div>
    {% endif %}

    <!-- Edit Form -->
    <form method="POST" action="/admin/controls/{{ control.id }}/save" class="space-y-6">
        <!-- Requirements Section -->
        <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-6 shadow-sm">
            <div class="flex items-center gap-2 mb-4">
                <div class="bg-amber-100 dark:bg-amber-900/40 text-amber-600 dark:text-amber-400 p-2 rounded-lg flex items-center justify-center">
                    <span class="material-symbols-outlined text-[18px]">description</span>
                </div>
                <h2 class="text-lg font-bold text-slate-900 dark:text-white">Requirements</h2>
            </div>

            <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">
                Define what must be implemented to satisfy this control. Use bullet points with indentation for hierarchical lists.
            </p>

            <textarea
                name="requirements_text"
                rows="8"
                placeholder="â€¢ Main requirement&#10;  â—¦ Sub-requirement&#10;  â—¦ Another sub-point&#10;â€¢ Second requirement"
                class="w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-amber-500/50 focus:border-amber-500 font-mono text-sm">{{ control.requirements_text or '' }}</textarea>

            <p class="text-[11px] text-slate-400 dark:text-slate-500 mt-2">
                ðŸ’¡ Use spaces/tabs for indentation to create sub-levels
            </p>
        </div>

        <!-- Testing Procedures Section -->
        <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-6 shadow-sm">
            <div class="flex items-center gap-2 mb-4">
                <div class="bg-blue-100 dark:bg-blue-900/40 text-blue-600 dark:text-blue-400 p-2 rounded-lg flex items-center justify-center">
                    <span class="material-symbols-outlined text-[18px]">assignment_turned_in</span>
                </div>
                <h2 class="text-lg font-bold text-slate-900 dark:text-white">Testing Procedures</h2>
            </div>

            <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">
                Describe how to verify that this control is properly implemented and operating effectively.
            </p>

            <textarea
                name="testing_procedures_text"
                rows="8"
                placeholder="â€¢ Test step 1&#10;  â—¦ Verification method&#10;  â—¦ Expected result&#10;â€¢ Test step 2"
                class="w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 font-mono text-sm">{{ control.testing_procedures_text or '' }}</textarea>

            <p class="text-[11px] text-slate-400 dark:text-slate-500 mt-2">
                ðŸ’¡ Use spaces/tabs for indentation to create sub-levels
            </p>
        </div>

        <!-- Check Points Section -->
        <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-6 shadow-sm">
            <div class="flex items-center gap-2 mb-4">
                <div class="bg-purple-100 dark:bg-purple-900/40 text-purple-600 dark:text-purple-400 p-2 rounded-lg flex items-center justify-center">
                    <span class="material-symbols-outlined text-[18px]">checklist</span>
                </div>
                <h2 class="text-lg font-bold text-slate-900 dark:text-white">Check Points</h2>
            </div>

            <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">
                Specific items to check or verify during assessment. This helps auditors know exactly what to look for.
            </p>

            <textarea
                name="check_points_text"
                rows="8"
                placeholder="â€¢ Primary checkpoint&#10;  - Sub-checkpoint 1&#10;  - Sub-checkpoint 2&#10;â€¢ Secondary checkpoint"
                class="w-full px-4 py-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-white placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500/50 focus:border-purple-500 font-mono text-sm">{{ control.check_points_text or '' }}</textarea>

            <p class="text-[11px] text-slate-400 dark:text-slate-500 mt-2">
                ðŸ’¡ Use spaces/tabs for indentation to create sub-levels
            </p>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-3 pt-4">
            <button
                type="submit"
                class="flex-1 py-3 bg-primary text-white rounded-lg font-bold shadow-lg shadow-primary/20 hover:bg-primary/90 transition-all flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-lg">save</span>
                Save Changes
            </button>
            <a href="/admin/controls"
                class="px-6 py-3 rounded-lg border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400 font-bold hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-lg">close</span>
                Cancel
            </a>
        </div>
    </form>

    <!-- Preview Section -->
    <div class="mt-12 pt-8 border-t border-slate-200 dark:border-slate-800">
        <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-6">Preview</h3>
        <div class="grid grid-cols-1 gap-6">
            <!-- Requirements Preview -->
            {% if control.requirements_text %}
            <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-5 shadow-sm relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-amber-500"></div>
                <h4 class="text-xs font-bold text-slate-900 dark:text-white uppercase tracking-wider mb-3 flex items-center gap-2">
                    <div class="bg-amber-100 dark:bg-amber-900/40 text-amber-600 dark:text-amber-400 p-1.5 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-[16px]">description</span>
                    </div>
                    Requirements
                </h4>
                <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed whitespace-pre-wrap break-words">
                    {{- control.requirements_text }}</p>
            </div>
            {% endif %}

            <!-- Testing Procedures Preview -->
            {% if control.testing_procedures_text %}
            <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-5 shadow-sm relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                <h4 class="text-xs font-bold text-slate-900 dark:text-white uppercase tracking-wider mb-3 flex items-center gap-2">
                    <div class="bg-blue-100 dark:bg-blue-900/40 text-blue-600 dark:text-blue-400 p-1.5 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-[16px]">assignment_turned_in</span>
                    </div>
                    Testing Procedures
                </h4>
                <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed whitespace-pre-wrap break-words">
                    {{- control.testing_procedures_text }}</p>
            </div>
            {% endif %}

            <!-- Check Points Preview -->
            {% if control.check_points_text %}
            <div class="bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 p-5 shadow-sm relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1 h-full bg-purple-500"></div>
                <h4 class="text-xs font-bold text-slate-900 dark:text-white uppercase tracking-wider mb-4 flex items-center gap-2">
                    <div class="bg-purple-100 dark:bg-purple-900/40 text-purple-600 dark:text-purple-400 p-1.5 rounded-lg flex items-center justify-center">
                        <span class="material-symbols-outlined text-[16px]">checklist</span>
                    </div>
                    Check Points
                </h4>
                <div class="space-y-1">
                    {% set lines = control.check_points_text.strip().split('\n') %}
                    {% for line in lines %}
                        {% if line.strip() %}
                            {% set indent_level = (line | length) - (line | trim | length) %}
                            {% set indent_spaces = indent_level // 2 %}
                            {% set clean_text = line.strip() | replace('â€¢ ', '') | replace('- ', '') | replace('* ', '') | replace('â€“ ', '') | replace('â—¦ ', '') %}

                            {% if indent_spaces == 0 %}
                                <div class="flex gap-2 items-start">
                            {% elif indent_spaces == 1 %}
                                <div class="flex gap-2 items-start pl-4">
                            {% elif indent_spaces == 2 %}
                                <div class="flex gap-2 items-start pl-8">
                            {% else %}
                                <div class="flex gap-2 items-start pl-12">
                            {% endif %}
                                <div class="flex-shrink-0 mt-1">
                                    {% if indent_spaces == 0 %}
                                        <div class="w-2 h-2 rounded-full bg-purple-500"></div>
                                    {% elif indent_spaces == 1 %}
                                        <div class="w-1.5 h-1.5 rounded-full bg-purple-400"></div>
                                    {% else %}
                                        <div class="w-1 h-1 rounded-full bg-purple-300"></div>
                                    {% endif %}
                                </div>
                                <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed flex-1">
                                    {{ clean_text }}
                                </p>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
        0% {
            opacity: 0;
            transform: translateY(5px);
        }

        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}
